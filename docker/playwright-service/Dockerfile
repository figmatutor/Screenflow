# ğŸ­ Playwright Docker Service
# ì™„ì „í•œ ë¸Œë¼ìš°ì € í™˜ê²½ì„ í¬í•¨í•œ ìŠ¤í¬ë¦°ìƒ· ì„œë¹„ìŠ¤

FROM mcr.microsoft.com/playwright:v1.40.0-focal

# í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    gnupg \
    ca-certificates \
    fonts-liberation \
    fonts-noto-color-emoji \
    fonts-noto-cjk \
    && rm -rf /var/lib/apt/lists/*

# Node.js 20 ì„¤ì¹˜
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# package.json ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm ci --only=production

# Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ (ëª¨ë“  ë¸Œë¼ìš°ì €)
RUN npx playwright install --with-deps chromium firefox webkit

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ë¹„root ì‚¬ìš©ì ìƒì„± (ë³´ì•ˆ)
RUN groupadd -r playwright && useradd -r -g playwright -G audio,video playwright \
    && mkdir -p /home/playwright/Downloads \
    && chown -R playwright:playwright /home/playwright \
    && chown -R playwright:playwright /app

# ì‚¬ìš©ì ì „í™˜
USER playwright

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 3001

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3001/health || exit 1

# ì„œë¹„ìŠ¤ ì‹œì‘
CMD ["node", "server.js"]
